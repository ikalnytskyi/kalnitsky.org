<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/pygments.css" />
    <link rel="canonical" href="https://kalnytskyi.com/posts/setup-wireguard-systemd-networkd/" />
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Ihor Kalnytskyi" />

    <meta name="author" content="Ihor Kalnytskyi" />
    <meta name="description" content="WireGuard is an extremely simple, fast and modern VPN that is built into Linux kernel. In this post you can learn more on how to setup a WireGuard VPN server on Linux using systemd-networkd network manager that is a part of most Linux distributions." />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@ikalnytskyi" />
    <meta name="twitter:title" content="Setup a WireGuard server using systemd-networkd" />
    <meta name="twitter:description" content="WireGuard is an extremely simple, fast and modern VPN that is built into Linux kernel. In this post you can learn more on how to setup a WireGuard VPN server on Linux using systemd-networkd network manager that is a part of most Linux distributions." />

    <meta property="og:title" content="Setup a WireGuard server using systemd-networkd" />
    <meta property="og:description" content="WireGuard is an extremely simple, fast and modern VPN that is built into Linux kernel. In this post you can learn more on how to setup a WireGuard VPN server on Linux using systemd-networkd network manager that is a part of most Linux distributions." />
    <meta property="og:url" content="https://kalnytskyi.com/posts/setup-wireguard-systemd-networkd/" />
    <meta property="og:site_name" content="Ihor Kalnytskyi" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2022-02-07T00:00:00+00:00" />
    <meta property="article:modified_time" content="2022-07-10T12:23:15.733263+00:00" />
    <meta property="article:author" content="Ihor Kalnytskyi" />

    <title>Setup a WireGuard server using systemd-networkd</title>
</head>
<body>
  <div class="banner"><a rel="nofollow" href="https://www.comebackalive.in.ua/donate">Save lives in Ukraine</a> â†’</div>

  <aside>
    <img class="about-pic" src="/about/me.jpg" alt="photo" />
    <span class="about-txt"><a href="/about/" rel="me">Ihor Kalnytskyi</a>'s<br />
thoughts & writings</span>

    <div class="nav-wrapper">
    <nav>
      <span><a href="/">Archives</a></span>
      <span><a href="/talks/">Talks</a></span>
      <span><a href="/feed.xml">Feed</a></span>
    </nav>
    </div>
  </aside>

  <main>
    <article>
      <header>
        <time datetime="2022-02-07T00:00:00+00:00">February 07, 2022</time>
        <h1>Setup a WireGuard server using systemd-networkd</h1>
      </header>

      <p>WireGuard is an extremely simple, fast and modern VPN that is built into Linux
kernel 5.6 (released on Mar 29, 2020) and above. It mimics the model of SSH and
requires VPN peers to know each others public keys. I highly recommend to read
<a href="https://www.wireguard.com">https://www.wireguard.com</a> regardless of this post.</p>
<p>When it comes to WireGuard, there's one interesting aspect: it has no notion of
'server', it's distributed by design and no blockchain is involved. Blockchain
enthusiasts may found this surprising but distributed software were invented
long before the blockchain ðŸ˜…. Each peer may connect to other peers assuming
they know each other (i.e. public key, IP) and there's a connectivity between
them. The 'server' is rather a behaviour one may expect from a certain peer.
There are 3 key points that are normally expected from a 'server' peer:</p>
<ul>
<li>The peer is publicly available, so other peers may connect to it even when
behind SNAT.</li>
<li>The peer can act as a proxy and connect other peers into a single network.</li>
<li>The peer can act as a gateway to the Internet.</li>
</ul>
<p>There are number of ways to configure WireGuard on a Linux machine. My favorite
one is to use <a href="https://man.archlinux.org/man/systemd-networkd.8.en">systemd-networkd</a>, a system service that manages both networks
and network devices. It's distributed as part of systemd suite, so most likely
you have it installed, and it supports WireGuard starting with v237. It's a
good choice for a Linux server because it requires no extra software.</p>
<p>For instance we want to setup the following VPN network:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Option</th>
<th style="text-align:left">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Network</td>
<td style="text-align:left"><code>10.0.0.0/24</code></td>
</tr>
<tr>
<td style="text-align:left">Server</td>
<td style="text-align:left"><code>10.0.0.1</code></td>
</tr>
<tr>
<td style="text-align:left">Peer A</td>
<td style="text-align:left"><code>10.0.0.20</code></td>
</tr>
<tr>
<td style="text-align:left">Peer B</td>
<td style="text-align:left"><code>10.0.0.30</code></td>
</tr>
</tbody>
</table>
<p>First thing to do is to set up a virtual network device for a WireGuard tunnel.
This can be achieved by means of a <a href="https://man.archlinux.org/man/systemd.netdev.5">systemd.netdev(5)</a> unit
that must be created in <code>/etc/systemd/network/</code> directory. The WireGuard
network device must know about number of things:</p>
<ul>
<li>The port to accept new connections on.</li>
<li>The private key of the server.</li>
<li>The list of known peers and their public keys.</li>
</ul>
<p>This is how some <code>/etc/systemd/network/wg0.netdev</code> could look like:</p>
<pre><code class="language-ini"><span class="k">[NetDev]</span><span class="w"></span>
<span class="na">Name</span><span class="o">=</span><span class="s">wg0</span><span class="w"></span>
<span class="na">Kind</span><span class="o">=</span><span class="s">wireguard</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">wg0 - wireguard tunnel</span><span class="w"></span>

<span class="k">[WireGuard]</span><span class="w"></span>
<span class="na">ListenPort</span><span class="o">=</span><span class="s">51820</span><span class="w"></span>
<span class="na">PrivateKeyFile</span><span class="o">=</span><span class="s">/etc/systemd/network/wg0.key</span><span class="w"></span>

<span class="k">[WireGuardPeer]</span><span class="w"></span>
<span class="na">AllowedIPs</span><span class="o">=</span><span class="s">10.0.0.20/32</span><span class="w"></span>
<span class="na">PublicKey</span><span class="o">=</span><span class="s">9vzzasvYciJLmhjrt9Aj9aQYe1gnUxI44ShVLQPrDQA=</span><span class="w"></span>

<span class="k">[WireGuardPeer]</span><span class="w"></span>
<span class="na">AllowedIPs</span><span class="o">=</span><span class="s">10.0.0.30/32</span><span class="w"></span>
<span class="na">PublicKey</span><span class="o">=</span><span class="s">9vzzasvYciJLmhjrt9Aj9aQYe1gnUxI44ShVLQPrDQA=</span><span class="w"></span>
</code></pre>
<p>The content of <code>/etc/systemd/network/wg0.key</code> can be generated by invoking
<code>$ wg genkey</code> command and must be readable by the <code>systemd-network</code> user.
What's notable here is that <code>$ wg genkey</code> can be executed anywhere, even on
your laptop, there's no need to install extra software on the server.</p>
<p>Next thing to do is to use a <a href="https://man.archlinux.org/man/systemd.network.5">systemd.network(5)</a> unit to
setup a network. The purpose of the network is to assign a proper IP address on
the network device, set proper routes and so on.</p>
<p>This how some <code>/etc/systemd/network/wg0.network</code> could look like:</p>
<pre><code class="language-ini"><span class="k">[Match]</span><span class="w"></span>
<span class="na">Name</span><span class="o">=</span><span class="s">wg0</span><span class="w"></span>

<span class="k">[Network]</span><span class="w"></span>
<span class="na">Address</span><span class="o">=</span><span class="s">10.0.0.1/24</span><span class="w"></span>
<span class="na">IPForward</span><span class="o">=</span><span class="s">yes</span><span class="w"></span>
<span class="na">IPMasquerade</span><span class="o">=</span><span class="s">yes</span><span class="w"></span>
</code></pre>
<p>There are couple of things to note:</p>
<ul>
<li>Since <code>/24</code> network mask is used, systemd-networkd will automatically add a
route for the whole network to be routed via the WireGuard tunnel. Without
that mask, it'd be up to a user to configure proper routing.</li>
<li>Both <code>IPForward</code> and <code>IPMasquerade</code> are only needed if the server is
expected to be used as a gateway to the Internet. Without these options,
it'd be up to a user to configure the firewall.</li>
</ul>
<p>When both the network device and the network are configured, the only remained
step is to run <code>$ networkctl reload</code> to pipe in and apply latest configuration.</p>

    </article>
  </main>
</body>