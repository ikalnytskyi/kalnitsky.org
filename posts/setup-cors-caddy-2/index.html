<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/pygments.css" />
    <link rel="canonical" href="https://kalnytskyi.com/posts/setup-cors-caddy-2/" />
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Ihor Kalnytskyi" />

    <meta name="author" content="Ihor Kalnytskyi" />
    <meta name="description" content="A note about how to setup CORS in Caddy 2." />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@ikalnytskyi" />
    <meta name="twitter:title" content="Setup CORS in Caddy 2" />
    <meta name="twitter:description" content="A note about how to setup CORS in Caddy 2." />

    <meta property="og:title" content="Setup CORS in Caddy 2" />
    <meta property="og:description" content="A note about how to setup CORS in Caddy 2." />
    <meta property="og:url" content="https://kalnytskyi.com/posts/setup-cors-caddy-2/" />
    <meta property="og:site_name" content="Ihor Kalnytskyi" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2022-01-12T00:00:00+00:00" />
    <meta property="article:modified_time" content="2022-04-08T21:22:33.213052+00:00" />
    <meta property="article:author" content="Ihor Kalnytskyi" />

    <title>Setup CORS in Caddy 2</title>
</head>
<body>
  <div class="banner">
    <a href="https://www.comebackalive.in.ua/donate">Save lives in Ukraine</a> â†’
  </div>

  <aside>
    <img class="about-pic" src="/about/me.jpg" alt="Ihor's photo" />
    <span class="about-txt"><a href="/about/" rel="me">Ihor Kalnytskyi</a>'s<br />
thoughts & writings</span>

    <div class="nav-wrapper">
    <nav>
      <span><a href="/">Archives</a></span>
      <span><a href="/talks/">Talks</a></span>
      <span><a href="/feed.xml">Feed</a></span>
    </nav>
    </div>
  </aside>

  <main>
    <article>
      <header>
        <time datetime="2022-01-12T00:00:00+00:00">January 12, 2022</time>
        <h1>Setup CORS in Caddy 2</h1>
      </header>

      <p><a href="https://caddyserver.com/">Caddy 2</a> is an open source web server with automatic HTTPS. It's a wise choice
for pet projects or self-hosted services, since you are free from managing TLS
certs on your own and wiring things together can be super annoying.</p>
<p>One missing feature in Caddy 2 is <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a> support. For a &quot;batteries included&quot;
web server, it's rather surprising. Fortunately, one can use the following
<a href="https://caddyserver.com/docs/caddyfile/concepts#snippets">Caddy snippet</a> to augment any site with CORS headers without repeating oneself
over and over again.</p>
<p><strong>Please note</strong>, you might want to update the list of headers returned by
<code>Access-Control-Allow-Headers</code> and <code>Access-Control-Expose-Headers</code> HTTP headers
according to your application needs. Please refer to the CORS documentation to
learn more what they mean.</p>
<pre><code>(cors) {
  @cors_preflight method OPTIONS
  @cors header Origin {args.0}

  handle @cors_preflight {
    header Access-Control-Allow-Origin &quot;{args.0}&quot;
    header Access-Control-Allow-Methods &quot;GET, POST, PUT, PATCH, DELETE&quot;
    header Access-Control-Allow-Headers &quot;Content-Type&quot;
    header Access-Control-Max-Age &quot;3600&quot;
    respond &quot;&quot; 204
  }

  handle @cors {
    header Access-Control-Allow-Origin &quot;{args.0}&quot;
    header Access-Control-Expose-Headers &quot;Link&quot;
  }
}

example.com {
  import cors https://example.com
  reverse_proxy localhost:8080
}
</code></pre>
<p>The nice part about this snippet is that CORS headers are only returned for the
requests with <code>Origin</code> HTTP header. That header is normally used by browsers
only, which means you won't see CORS headers in the responses for the requests
sent by <code>curl</code> or your-programming-language-of-choice.</p>
<p>I've been successfully using this snippet for quite a while now <a href="https://github.com/xsnippet/xsnippet-infra/blob/1d583a6868597cb71bb2ae08f60bc42ac4364e91/roles/xsnippet_api/templates/caddy.j2#L1-L17">to protect</a>
<a href="https://github.com/xsnippet/xsnippet-api">xsnippet-api</a> served at <a href="https://api.xsnippet.org">api.xsnippet.org</a>, so it can be used by
<a href="https://github.com/xsnippet/xsnippet-web">xsnippet-web</a> served at <a href="https://xsnippet.org">xsnippet.org</a>.</p>

    </article>
  </main>
</body>