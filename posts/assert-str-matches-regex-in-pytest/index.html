<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/pygments.css" />
    <link rel="canonical" href="https://kalnytskyi.com/posts/assert-str-matches-regex-in-pytest/" />
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Ihor Kalnytskyi" />

    <meta name="author" content="Ihor Kalnytskyi" />
    <meta name="description" content="A simple trick regarding how to check that strings matches certain pattern using pytest in python tests." />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@ikalnytskyi" />
    <meta name="twitter:title" content="Assert that str matches regex in pytest" />
    <meta name="twitter:description" content="A simple trick regarding how to check that strings matches certain pattern using pytest in python tests." />

    <meta property="og:title" content="Assert that str matches regex in pytest" />
    <meta property="og:description" content="A simple trick regarding how to check that strings matches certain pattern using pytest in python tests." />
    <meta property="og:url" content="https://kalnytskyi.com/posts/assert-str-matches-regex-in-pytest/" />
    <meta property="og:site_name" content="Ihor Kalnytskyi" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2018-04-30T00:00:00+00:00" />
    <meta property="article:modified_time" content="2022-03-09T17:19:11.517177+00:00" />
    <meta property="article:author" content="Ihor Kalnytskyi" />

    <title>Assert that str matches regex in pytest</title>
</head>
<body>
  <div class="banner">
    Русский военный корабль, иди нахуй.
    <a href="https://www.comebackalive.in.ua/donate">Help Ukrainian army →</a>
  </div>

  <aside>
    <img class="about-pic" src="/about/me.jpg" alt="Ihor's photo" />
    <span class="about-txt"><a href="/about/" rel="me">Ihor Kalnytskyi</a>'s<br />
thoughts & writings</span>

    <div class="nav-wrapper">
    <nav>
      <span><a href="/">Archives</a></span>
      <span><a href="/talks/">Talks</a></span>
      <span><a href="/feed.xml">Feed</a></span>
    </nav>
    </div>
  </aside>

  <main>
    <article>
      <header>
        <time datetime="2018-04-30T00:00:00+00:00">April 30, 2018</time>
        <h1>Assert that str matches regex in pytest</h1>
      </header>

      <p>Once in a while every Pythonista faces a need to test that some string value
matches a regex pattern. When it comes we have no option but to use <code>re</code> module
directly.</p>
<pre><code class="language-python"><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">test_something_very_useful</span><span class="p">():</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">get_some_string</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre>
<p>While it works fine in case of lone string, it's not always convenient to do
the same when a string is a part of more complex data structure (e.g. <code>dict</code>),
because you need to extract the string, check it and only then get back to
check rest attributes.</p>
<pre><code class="language-python"><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">test_something_even_more_useful</span><span class="p">():</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">get_some_structure</span><span class="p">()</span>

    <span class="c1"># inconvenient and boring! :(</span>
    <span class="k">assert</span> <span class="s1">&#39;value&#39;</span> <span class="ow">in</span> <span class="n">mapping</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># rest assertion</span>
    <span class="k">assert</span> <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</code></pre>
<p>Fortunately, it's pretty easy to write convenient <code>pytest</code> helper that would
check a pattern as a part of checking the whole data structure.</p>
<pre><code class="language-python"><span class="k">def</span> <span class="nf">test_something_even_more_useful</span><span class="p">():</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">get_some_structure</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">pytest_regex</span><span class="p">(</span><span class="s1">&#39;\d+&#39;</span><span class="p">)}</span>
</code></pre>
<p>Looks better, huh? :) So the trick is done by the following few lines which
we're successfully using in <a href="https://github.com/xsnippet/xsnippet-api">XSnippet API</a>.</p>
<pre><code class="language-python"><span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">pytest_regex</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Assert that a given string meets some expectations.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">actual</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span><span class="o">.</span><span class="n">pattern</span>
</code></pre>
<p>Well, actually, it's not by any means tied to <code>pytest</code> and could be used even
in non-test production code, though I found this rather queer.</p>

    </article>
  </main>
</body>