<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/pygments.css" />
    <link rel="canonical" href="https://kalnytskyi.com/posts/setup-cors-caddy-2/" />
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Ihor Kalnytskyi" />

    <meta name="author" content="Ihor Kalnytskyi" />
    <meta name="description" content="Caddy 2 is an open source web server with automatic HTTPS which makes it a gread choice to be used as a reverse proxy. This post provides a recipe of how to configure sross-origin resource sharing (CORS) in Caddy." />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@ikalnytskyi" />
    <meta name="twitter:title" content="Setup CORS in Caddy 2" />
    <meta name="twitter:description" content="Caddy 2 is an open source web server with automatic HTTPS which makes it a gread choice to be used as a reverse proxy. This post provides a recipe of how to configure sross-origin resource sharing (CORS) in Caddy." />

    <meta property="og:title" content="Setup CORS in Caddy 2" />
    <meta property="og:description" content="Caddy 2 is an open source web server with automatic HTTPS which makes it a gread choice to be used as a reverse proxy. This post provides a recipe of how to configure sross-origin resource sharing (CORS) in Caddy." />
    <meta property="og:url" content="https://kalnytskyi.com/posts/setup-cors-caddy-2/" />
    <meta property="og:site_name" content="Ihor Kalnytskyi" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2022-01-12T00:00:00+00:00" />
    <meta property="article:modified_time" content="2023-11-14T21:19:30.211364+00:00" />
    <meta property="article:author" content="Ihor Kalnytskyi" />

    <title>Setup CORS in Caddy 2</title>
</head>
<body>
  <div class="banner"><a rel="nofollow" href="https://savelife.in.ua/en/donate-en/">Save lives in Ukraine</a> â†’</div>

  <aside>
    <img class="about-pic" src="/about/me.jpg" alt="photo" />
    <span class="about-txt"><a href="/about/" rel="me">Ihor Kalnytskyi</a>'s<br />
thoughts & writings</span>

    <div class="nav-wrapper">
    <nav>
      <span><a href="/">Archives</a></span>
      <span><a href="/talks/">Talks</a></span>
      <span><a href="/feed.xml">Feed</a></span>
    </nav>
    </div>
  </aside>

  <main>
    <article>
      <header>
        <time datetime="2022-01-12T00:00:00+00:00">January 12, 2022</time>
        <h1>Setup CORS in Caddy 2</h1>
      </header>

      <p><a href="https://caddyserver.com/">Caddy 2</a> is an open source web server with automatic HTTPS. It's a wise choice
for pet projects or self-hosted services, since you are free from managing TLS
certs on your own and wiring things up can be super annoying.</p>
<p>One missing feature in Caddy 2, however, is cross-origin resource sharing
(<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>) support. For a &quot;batteries included&quot; web server, it's rather
surprising. Fortunately, one can use the following <a href="https://caddyserver.com/docs/caddyfile/concepts#snippets">Caddy snippet</a> to augment
any site with CORS headers without repeating oneself over and over again.</p>
<div class="note">
<p>You might want to update the list of headers returned by
<code>Access-Control-Allow-Headers</code> or <code>Access-Control-Expose-Headers</code> HTTP headers
according to your application needs. Please refer to the CORS documentation to
learn more what they are about.</p>
</div>
<pre><code>(cors) {
  @cors_preflight method OPTIONS
  @cors header Origin {args.0}

  handle @cors_preflight {
    header Access-Control-Allow-Origin "{args.0}"
    header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE"
    header Access-Control-Allow-Headers "Content-Type"
    header Access-Control-Max-Age "3600"
    respond "" 204
  }

  handle @cors {
    header Access-Control-Allow-Origin "{args.0}"
    header Access-Control-Expose-Headers "Link"
  }
}

example.com {
  import cors https://example.com
  reverse_proxy localhost:8080
}
</code></pre>
<p>The nice part about this snippet is that CORS headers are only returned for
HTTP requests with the <code>Origin</code> HTTP header. That header is normally used by
browsers only, which means you won't see CORS headers in responses for requests
sent by <code>curl</code> or <em>your-programming-language-of-choice</em>.</p>
<p>I've been successfully using this snippet for quite a while now <a href="https://github.com/xsnippet/xsnippet-infra/blob/1d583a6868597cb71bb2ae08f60bc42ac4364e91/roles/xsnippet_api/templates/caddy.j2#L1-L17">to protect</a>
<a href="https://api.xsnippet.org">api.xsnippet.org</a>, so it can be accessed by <a href="https://xsnippet.org">xsnippet.org</a>.</p>

    </article>
  </main>
</body>