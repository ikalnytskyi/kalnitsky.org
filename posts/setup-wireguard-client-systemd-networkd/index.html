<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/pygments.css" />
    <link rel="canonical" href="https://kalnytskyi.com/posts/setup-wireguard-client-systemd-networkd/" />
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Ihor Kalnytskyi" />

    <meta name="author" content="Ihor Kalnytskyi" />
    <meta name="description" content="WireGuard is an extremely simple, fast and modern VPN that is built into Linux kernel. In this post you can learn more on how to setup a WireGuard VPN client on Linux using systemd-networkd network manager that is a part of most Linux distributions." />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@ikalnytskyi" />
    <meta name="twitter:title" content="Setup a WireGuard client using systemd-networkd" />
    <meta name="twitter:description" content="WireGuard is an extremely simple, fast and modern VPN that is built into Linux kernel. In this post you can learn more on how to setup a WireGuard VPN client on Linux using systemd-networkd network manager that is a part of most Linux distributions." />

    <meta property="og:title" content="Setup a WireGuard client using systemd-networkd" />
    <meta property="og:description" content="WireGuard is an extremely simple, fast and modern VPN that is built into Linux kernel. In this post you can learn more on how to setup a WireGuard VPN client on Linux using systemd-networkd network manager that is a part of most Linux distributions." />
    <meta property="og:url" content="https://kalnytskyi.com/posts/setup-wireguard-client-systemd-networkd/" />
    <meta property="og:site_name" content="Ihor Kalnytskyi" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2022-09-03T00:00:00+00:00" />
    <meta property="article:modified_time" content="2022-09-17T19:16:02.463199+00:00" />
    <meta property="article:author" content="Ihor Kalnytskyi" />

    <title>Setup a WireGuard client using systemd-networkd</title>
</head>
<body>
  <div class="banner"><a rel="nofollow" href="https://www.comebackalive.in.ua/donate">Save lives in Ukraine</a> →</div>

  <aside>
    <img class="about-pic" src="/about/me.jpg" alt="photo" />
    <span class="about-txt"><a href="/about/" rel="me">Ihor Kalnytskyi</a>'s<br />
thoughts & writings</span>

    <div class="nav-wrapper">
    <nav>
      <span><a href="/">Archives</a></span>
      <span><a href="/talks/">Talks</a></span>
      <span><a href="/feed.xml">Feed</a></span>
    </nav>
    </div>
  </aside>

  <main>
    <article>
      <header>
        <time datetime="2022-09-03T00:00:00+00:00">September 03, 2022</time>
        <h1>Setup a WireGuard client using systemd-networkd</h1>
      </header>

      <div class="note">
<p>Please check out <a href="/posts/setup-wireguard-systemd-networkd/">«Setup a WireGuard server using systemd-networkd»</a>
to learn more about WireGuard in general and network topology outlined in this
post.</p>
<p>On Feb 24, 2022, Russia began a full scale invasion of Ukraine. The terror they
brought to my country is devastating, and so publication of this post has been
postponed till better times. Only now I finally found some strength inside to
finish and publish this writing.</p>
</div>
<p>WireGuard is a great VPN choice for your home, and maybe even for your company.
It's simple, fast, built into Linux kernel 5.6 and above, and can be configured
via <a href="https://man.archlinux.org/man/systemd-networkd.8.en">systemd-networkd</a> in no time. The systemd suite supports WireGuard
starting with v237 and is most likely installed on your Linux machine.</p>
<p>Let us try to setup a wireguard 'client' for the following VPN network:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Option</th>
<th style="text-align:left">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Network</td>
<td style="text-align:left"><code>10.0.0.0/24</code></td>
</tr>
<tr>
<td style="text-align:left">Server</td>
<td style="text-align:left"><code>10.0.0.1</code></td>
</tr>
<tr>
<td style="text-align:left">Client</td>
<td style="text-align:left"><code>10.0.0.20</code></td>
</tr>
</tbody>
</table>
<p>First thing to do is to set up a virtual network device for a WireGuard tunnel.
This can be achieved by means of a <a href="https://man.archlinux.org/man/systemd.netdev.5">systemd.netdev(5)</a> unit
that must be created in <code>/etc/systemd/network/</code> directory. The WireGuard
network device must know about number of things:</p>
<ul>
<li>The private key of the peer.</li>
<li>The endpoint of the 'server' peer and its public key.</li>
</ul>
<p>Unlike 'server', a 'client' peer doesn't require port configuration because
it's the 'client' that initiates connection not the other way round. This is
how some <code>/etc/systemd/network/wg0.netdev</code> could look like:</p>
<pre><code class="language-ini"><span class="k">[NetDev]</span><span class="w"></span>
<span class="na">Name</span><span class="o">=</span><span class="s">wg0</span><span class="w"></span>
<span class="na">Kind</span><span class="o">=</span><span class="s">wireguard</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">wg0 - wireguard tunnel</span><span class="w"></span>

<span class="k">[WireGuard]</span><span class="w"></span>
<span class="na">PrivateKeyFile</span><span class="o">=</span><span class="s">/etc/systemd/network/wg0.key</span><span class="w"></span>
<span class="na">FirewallMark</span><span class="o">=</span><span class="s">0x8888</span><span class="w"></span>

<span class="k">[WireGuardPeer]</span><span class="w"></span>
<span class="na">PublicKey</span><span class="o">=</span><span class="s">TPouHhVqvgAMfa9mNwZOh59kifUAsdn9Vtgsj2IsKVU=</span><span class="w"></span>
<span class="na">AllowedIPs</span><span class="o">=</span><span class="s">0.0.0.0/0</span><span class="w"></span>
<span class="na">Endpoint</span><span class="o">=</span><span class="s">vpn.example.com:51820</span><span class="w"></span>
</code></pre>
<p>The content of <code>/etc/systemd/network/wg0.key</code> can be generated by invoking
<code>$ wg genkey</code> command and must be readable by the <code>systemd-network</code> user.</p>
<p>There are couple of things to note:</p>
<ul>
<li>
<p>The <code>FirewallMark</code> option takes a number and is used to mark outgoing
WireGuard packets. Please remember that mark, it will be later used for
network configuration.</p>
</li>
<li>
<p>The <code>AllowedIPs</code> option is set to <code>0.0.0.0/0</code> because we're interested to
route all the traffic via the tunnel, i.e. surfing the Internet via VPN.
If your plans for the VPN is to connect multiple devices into a single
network, you should go with the network address only, e.g. <code>10.0.0.0/24</code>.</p>
</li>
<li>
<p>The <code>Endpoint</code> option takes a wireguard 'server' IP address or hostname,
followed by a colon, and then a port the 'server' accepts connection on. The
endpoint must be reachable from 'client' peers even when VPN is down.</p>
</li>
</ul>
<p>Next thing to do is to use a <a href="https://man.archlinux.org/man/systemd.network.5">systemd.network(5)</a> unit to
setup a network. The purpose of the network is to assign a proper IP address on
the network device, set proper routes and so on.</p>
<p>This how some <code>/etc/systemd/network/wg0.network</code> could look like:</p>
<pre><code class="language-ini"><span class="k">[Match]</span><span class="w"></span>
<span class="na">Name</span><span class="o">=</span><span class="s">wg0</span><span class="w"></span>

<span class="k">[Network]</span><span class="w"></span>
<span class="na">Address</span><span class="o">=</span><span class="s">10.0.0.20/24</span><span class="w"></span>
<span class="na">DNSDefaultRoute</span><span class="o">=</span><span class="s">true</span><span class="w"></span>
<span class="na">DNS</span><span class="o">=</span><span class="s">1.1.1.1</span><span class="w"></span>

<span class="k">[Link]</span><span class="w"></span>
<span class="na">ActivationPolicy</span><span class="o">=</span><span class="s">manual</span><span class="w"></span>

<span class="k">[RoutingPolicyRule]</span><span class="w"></span>
<span class="na">FirewallMark</span><span class="o">=</span><span class="s">0x8888</span><span class="w"></span>
<span class="na">InvertRule</span><span class="o">=</span><span class="s">true</span><span class="w"></span>
<span class="na">Table</span><span class="o">=</span><span class="s">1000</span><span class="w"></span>
<span class="na">Priority</span><span class="o">=</span><span class="s">10</span><span class="w"></span>

<span class="k">[Route]</span><span class="w"></span>
<span class="na">Gateway</span><span class="o">=</span><span class="s">10.0.0.1</span><span class="w"></span>
<span class="na">GatewayOnLink</span><span class="o">=</span><span class="s">true</span><span class="w"></span>
<span class="na">Table</span><span class="o">=</span><span class="s">1000</span><span class="w"></span>
</code></pre>
<p>There are a bunch of important stuff going on:</p>
<ul>
<li>
<p>Since <code>/24</code> network mask is used, systemd-networkd will automatically add a
route for the whole network to be routed via the WireGuard tunnel. Without
that mask, it'd be up to a user to properly configure routing on the system.</p>
</li>
<li>
<p>With <code>ActivationPolicy</code> set to <code>manual</code>, the VPN is not brought up on system
boot, and requires manual activation via <code>$ networkctl up wg0</code>. One can use
the <code>up</code> value to always activate VPN on system boot.</p>
</li>
<li>
<p>Both <code>RoutingPolicyRule</code> and <code>Route</code> come together and are only required if
you want to route all the traffic over the tunnel. The <code>Route</code> section
essentially creates a default route that routes packets to the wireguard
server. The <code>RoutingPolicyRule</code> section, on the other hand, says that this
new default route should be applied only for the packets not coming from the
wireguard network device (i.e. not being marked with a firewall mark).</p>
</li>
<li>
<p>When VPN is used as a gateway for the Internet, it's quite common to set
some non default DNS servers to resolve domain names. It could be your own
VPN server, or some third-party provider such as Cloudflare. In order to set
custom DNS servers when VPN connection is up, one can use <code>DNSDefaultRoute</code>
and <code>DNS</code> options. The former tells the system to use the latter to resolve
all domain names.</p>
</li>
</ul>
<p>When both the network device and the network are configured, the only remained
step is to run <code>$ networkctl reload</code> to pipe in and apply latest configuration
followed by <code>$networkctl up wg0</code> to bring the VPN up.</p>

    </article>
  </main>
</body>